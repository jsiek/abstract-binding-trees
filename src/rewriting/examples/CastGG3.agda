{-# OPTIONS --rewriting #-}
module rewriting.examples.CastGG3 where

open import Data.List using (List; []; _Рѕи_; length; map)
open import Data.Nat
open import Data.Bool using (true; false) renaming (Bool to ­Юћ╣)
open import Data.Nat.Properties 
open import Data.Product using (_,_;_├Ќ_; projРѓЂ; projРѓѓ; ╬Б-syntax; РѕЃ-syntax)
open import Data.Unit using (Ріц; tt)
open import Data.Unit.Polymorphic using () renaming (Ріц to topрхќ; tt to ttрхќ)
open import Data.Empty using (РіЦ; РіЦ-elim)
open import Data.Sum using (_Ріј_; injРѓЂ; injРѓѓ)
open import Relation.Binary.PropositionalEquality as Eq
  using (_РЅА_; _РЅб_; refl; sym; cong; subst; trans)
open import Relation.Nullary using (┬г_; Dec; yes; no)
open import Var
open import rewriting.examples.Cast
open import rewriting.examples.CastBigStep
open import rewriting.examples.CastDiverge
open import rewriting.examples.StepIndexedLogic2

Рё░Ріј­Юњ▒-type : Set
Рё░Ріј­Юњ▒-type = (Prec ├Ќ Term ├Ќ Term) Ріј (Prec ├Ќ Term ├Ќ Term)

Рё░Ріј­Юњ▒-ctx : Context
Рё░Ріј­Юњ▒-ctx = Рё░Ріј­Юњ▒-type Рѕи []

Рё░╦бРЪд_РЪД : Prec Рєњ Term Рєњ Term Рєњ Set╦б Рё░Ріј­Юњ▒-ctx (cons Now РѕЁ)
Рё░╦бРЪд AРіЉB РЪД M MРђ▓ = (injРѓѓ (AРіЉB , M , MРђ▓)) Рѕѕ zero╦б

­Юњ▒╦бРЪд_РЪД : Prec Рєњ Term Рєњ Term Рєњ Set╦б Рё░Ріј­Юњ▒-ctx (cons Now РѕЁ)
­Юњ▒╦бРЪд AРіЉB РЪД V VРђ▓ = (injРѓЂ (AРіЉB , V , VРђ▓)) Рѕѕ zero╦б

pre-Рё░ : Prec Рєњ Term Рєњ Term Рєњ Set╦б Рё░Ріј­Юњ▒-ctx (cons Later РѕЁ)
pre-­Юњ▒ : Prec Рєњ Term Рєњ Term Рєњ Set╦б Рё░Ріј­Юњ▒-ctx (cons Later РѕЁ)


pre-­Юњ▒ (РўЁ , РўЁ , unkРіЉ) (V РЪе G !РЪЕ) (VРђ▓ РЪе H !РЪЕ)
    with G РЅАрхЇ H
... | yes refl =
      let g = gndРЄњty G in
      (Value V)╦б ├Ќ╦б (Value VРђ▓)╦б ├Ќ╦б (Рќи╦б (­Юњ▒╦бРЪд (g , g , ReflРіЉ) РЪД V VРђ▓))
... | no neq = РіЦ ╦б
pre-­Юњ▒ (.РўЁ , $Рѓю ╬╣ , unkРіЉ) (V РЪе G !РЪЕ) VРђ▓
    with gndРЄњty G РіЉ? ($Рѓю ╬╣)
... | yes lt = (Value V)╦б ├Ќ╦б (Value VРђ▓)╦б
                  ├Ќ╦б Рќи╦б (­Юњ▒╦бРЪд (gndРЄњty G , $Рѓю ╬╣ , lt) РЪД V VРђ▓)
... | no nlt = РіЦ ╦б
pre-­Юњ▒ (.РўЁ , AРђ▓ РЄњ BРђ▓ , unkРіЉ) (V РЪе G !РЪЕ) VРђ▓
    with gndРЄњty G РіЉ? (AРђ▓ РЄњ BРђ▓)
... | yes lt = (Value V)╦б ├Ќ╦б (Value VРђ▓)╦б
                   ├Ќ╦б Рќи╦б (­Юњ▒╦бРЪд (gndРЄњty G , AРђ▓ РЄњ BРђ▓ , lt) РЪД V VРђ▓)
... | no nlt = РіЦ ╦б
pre-­Юњ▒ ($Рѓю ╬╣ , $Рѓю ╬╣ , baseРіЉ) ($ c) ($ cРђ▓) = (c РЅА cРђ▓) ╦б
pre-­Юњ▒ ((A РЄњ B) , (AРђ▓ РЄњ BРђ▓) , funРіЉ AРіЉAРђ▓ BРіЉBРђ▓) (кЏ N) (кЏ NРђ▓) =
    Рѕђ╦б[ W ] Рѕђ╦б[ WРђ▓ ] (pre-­Юњ▒ (A , AРђ▓ , AРіЉAРђ▓) W WРђ▓)
                      Рєњ╦б (pre-Рё░ (B , BРђ▓ , BРіЉBРђ▓) (N [ W ]) (NРђ▓ [ WРђ▓ ]))
pre-­Юњ▒ (A , AРђ▓ , AРіЉAРђ▓) V VРђ▓ = РіЦ ╦б

instance
  TermInhabited : Inhabited Term
  TermInhabited = record { elt = ` 0 }

pre-Рё░ c M MРђ▓ = ((РЄЉрхњ MРђ▓)РЂ▒ Рєњ╦б (РЄЉрхњ M)РЂ▒)
            ├Ќ╦б (Рѕђ╦б[ VРђ▓ ] (MРђ▓ РЄЊ VРђ▓)╦б Рєњ╦б (Value VРђ▓)╦б
                Рєњ╦б (РѕЃ╦б[ V ] (M РЄЊ V)╦б ├Ќ╦б (Value V)╦б ├Ќ╦б pre-­Юњ▒ c V VРђ▓))

pre-Рё░Ріј­Юњ▒ : Рё░Ріј­Юњ▒-type Рєњ Set╦б Рё░Ріј­Юњ▒-ctx (cons Later РѕЁ)
pre-Рё░Ріј­Юњ▒ (injРѓЂ (c , V , VРђ▓)) = pre-­Юњ▒ c V VРђ▓
pre-Рё░Ріј­Юњ▒ (injРѓѓ (c , M , MРђ▓)) = pre-Рё░ c M MРђ▓

Рё░Ріј­Юњ▒ : Рё░Ріј­Юњ▒-type Рєњ Setрхњ
Рё░Ріј­Юњ▒ X = ╬╝рхњ pre-Рё░Ріј­Юњ▒ X

­Юњ▒РЪд_РЪД : (c : Prec)  Рєњ Term Рєњ Term Рєњ Setрхњ
­Юњ▒РЪд c РЪД V VРђ▓ = Рё░Ріј­Юњ▒ (injРѓЂ (c , V , VРђ▓))

Рё░РЪд_РЪД : (c : Prec) Рєњ Term Рєњ Term Рєњ Setрхњ
Рё░РЪд c РЪД M MРђ▓ = Рё░Ріј­Юњ▒ (injРѓѓ (c , M , MРђ▓))

{------------- Equations for Рё░ and ­Юњ▒ -----------------------------------------}

РѕЃV­Юњ▒ : Prec Рєњ Term Рєњ Term Рєњ Term Рєњ Setрхњ
РѕЃV­Юњ▒ c M V VРђ▓ = (M РЄЊ V)рхњ ├Ќрхњ (Value V)рхњ ├Ќрхњ ­Юњ▒РЪд c РЪД V VРђ▓

РѕђVРђ▓РєњРѕЃV­Юњ▒ : Prec Рєњ Term Рєњ Term Рєњ Term Рєњ Setрхњ
РѕђVРђ▓РєњРѕЃV­Юњ▒ c M MРђ▓ VРђ▓ = (MРђ▓ РЄЊ VРђ▓)рхњ Рєњрхњ (Value VРђ▓)рхњ Рєњрхњ (РѕЃрхњ[ V ] РѕЃV­Юњ▒ c M V VРђ▓)

Рё░-def : Prec Рєњ Term Рєњ Term Рєњ Setрхњ
Рё░-def c M MРђ▓ = ((РЄЉрхњ MРђ▓) Рєњрхњ (РЄЉрхњ M)) ├Ќрхњ (Рѕђрхњ[ VРђ▓ ] РѕђVРђ▓РєњРѕЃV­Юњ▒ c M MРђ▓ VРђ▓)

Рё░-stmt : Рѕђ{c}{M MРђ▓} Рєњ Рё░РЪд c РЪД M MРђ▓ РЅАрхњ Рё░-def c M MРђ▓
Рё░-stmt {c}{M}{MРђ▓} =
  let XРѓѓ = injРѓѓ (c , M , MРђ▓) in
  Рё░РЪд c РЪД M MРђ▓                                      РЕдРЪе РЅАрхњ-refl refl РЪЕ
  ╬╝рхњ pre-Рё░Ріј­Юњ▒ XРѓѓ                                    РЕдРЪе fixpointрхњ pre-Рё░Ріј­Юњ▒ XРѓѓ РЪЕ
  # (pre-Рё░Ріј­Юњ▒ XРѓѓ) (Рё░Ріј­Юњ▒ , ttрхќ)                       РЕдРЪе EQ РЪЕ
  Рё░-def c M MРђ▓                                      Рѕј
  where
  EQ = cong-├Ќрхњ (РЅАрхњ-refl refl) (cong-Рѕђ ╬╗ VРђ▓ Рєњ
        cong-Рєњ{S = (MРђ▓ РЄЊ VРђ▓)рхњ} (РЅАрхњ-refl refl)
        (cong-Рєњ{S = (Value VРђ▓)рхњ} (РЅАрхњ-refl refl)
          (cong-РѕЃ ╬╗ V Рєњ cong-├Ќрхњ (РЅАрхњ-refl refl)
            (cong-├Ќрхњ (РЅАрхњ-refl refl)
            (РЅАрхњ-sym (fixpointрхњ pre-Рё░Ріј­Юњ▒ (injРѓЂ (_ , V , VРђ▓))))))))

­Юњ▒-dyn-dyn : Рѕђ{G}{V}{VРђ▓}
  Рєњ ­Юњ▒РЪд РўЁ , РўЁ , unkРіЉ РЪД (V РЪе G !РЪЕ) (VРђ▓ РЪе G !РЪЕ)
    РЅАрхњ (Value V)рхњ ├Ќрхњ (Value VРђ▓)рхњ
       ├Ќрхњ Рќирхњ (­Юњ▒РЪд gndРЄњty G , gndРЄњty G , ReflРіЉ РЪД V VРђ▓)
­Юњ▒-dyn-dyn {G}{V}{VРђ▓} =
  ­Юњ▒РЪд РўЁ , РўЁ , unkРіЉ РЪД (V РЪе G !РЪЕ) (VРђ▓ РЪе G !РЪЕ)        РЕдРЪе РЅАрхњ-refl refl РЪЕ
  Рё░Ріј­Юњ▒ XРѓЂ                                             РЕдРЪе fixpointрхњ pre-Рё░Ріј­Юњ▒ XРѓЂ РЪЕ
  # (pre-Рё░Ріј­Юњ▒ XРѓЂ) (Рё░Ріј­Юњ▒ , ttрхќ)                        РЕдРЪе EQ РЪЕ
  (Value V)рхњ ├Ќрхњ (Value VРђ▓)рхњ ├Ќрхњ Рќирхњ (­Юњ▒РЪд gndРЄњty G , gndРЄњty G , ReflРіЉ РЪД V VРђ▓) Рѕј
  where
  XРѓЂ = injРѓЂ ((РўЁ , РўЁ , unkРіЉ) , (V РЪе G !РЪЕ) , (VРђ▓ РЪе G !РЪЕ)) 
  EQ : # (pre-Рё░Ріј­Юњ▒ XРѓЂ) (Рё░Ріј­Юњ▒ , ttрхќ)
       РЅАрхњ (Value V)рхњ ├Ќрхњ (Value VРђ▓)рхњ 
           ├Ќрхњ Рќирхњ (­Юњ▒РЪд gndРЄњty G , gndРЄњty G , ReflРіЉ РЪД V VРђ▓)
  EQ
      with G РЅАрхЇ G
  ... | yes refl = РЅАрхњ-refl refl
  ... | no neq = РіЦ-elim (neq refl)

­Юњ▒-dyn-any : Рѕђ{G}{AРђ▓}{V}{VРђ▓}
   Рєњ (GРіЉAРђ▓ : gndРЄњty G РіЉ AРђ▓)
   Рєњ ­Юњ▒РЪд РўЁ , AРђ▓ , unkРіЉ РЪД (V РЪе G !РЪЕ) VРђ▓
     РЅАрхњ (Value V)рхњ ├Ќрхњ (Value VРђ▓)рхњ ├Ќрхњ Рќирхњ (­Юњ▒РЪд gndРЄњty G , AРђ▓ , GРіЉAРђ▓ РЪД V VРђ▓)
­Юњ▒-dyn-any {G}{AРђ▓}{V}{VРђ▓} GРіЉAРђ▓ =
  ­Юњ▒РЪд РўЁ , AРђ▓ , unkРіЉ РЪД (V РЪе G !РЪЕ) VРђ▓                         РЕдРЪе РЅАрхњ-refl refl РЪЕ
  Рё░Ріј­Юњ▒ (XРѓЂ G AРђ▓)                               РЕдРЪе fixpointрхњ pre-Рё░Ріј­Юњ▒ (XРѓЂ G AРђ▓) РЪЕ
  # (pre-Рё░Ріј­Юњ▒ (XРѓЂ G AРђ▓)) (Рё░Ріј­Юњ▒ , ttрхќ)                               РЕдРЪе EQ GРіЉAРђ▓ РЪЕ
  (Value V)рхњ ├Ќрхњ (Value VРђ▓)рхњ ├Ќрхњ Рќирхњ (­Юњ▒РЪд gndРЄњty G , AРђ▓ , GРіЉAРђ▓ РЪД V VРђ▓)  Рѕј 
  where
  XРѓЂ = ╬╗ G AРђ▓ Рєњ injРѓЂ ((РўЁ , AРђ▓ , unkРіЉ) , (V РЪе G !РЪЕ) , VРђ▓)
  EQ : Рѕђ{G}{AРђ▓}
     Рєњ (GРіЉAРђ▓ : gndРЄњty G РіЉ AРђ▓)
     Рєњ # (pre-Рё░Ріј­Юњ▒ (XРѓЂ G AРђ▓)) (Рё░Ріј­Юњ▒ , ttрхќ)
       РЅАрхњ (Value V)рхњ ├Ќрхњ (Value VРђ▓)рхњ ├Ќрхњ Рќирхњ (­Юњ▒РЪд gndРЄњty G , AРђ▓ , GРіЉAРђ▓ РЪД V VРђ▓)
  EQ {$рхЇ ╬╣} {.($Рѓю ╬╣)} baseРіЉ
      with ($Рѓю ╬╣) РіЉ? ($Рѓю ╬╣)
  ... | no nlt = РіЦ-elim (nlt baseРіЉ)
  ... | yes baseРіЉ = РЅАрхњ-refl refl
  EQ {РўЁРЄњРўЁ} {.(_ РЄњ _)} (funРіЉ unkРіЉ unkРіЉ) = РЅАрхњ-refl refl

­Юњ▒-base : Рѕђ{╬╣}{c}{cРђ▓}
  Рєњ ­Юњ▒РЪд ($Рѓю ╬╣ , $Рѓю ╬╣ , baseРіЉ) РЪД ($ c) ($ cРђ▓) РЅАрхњ (c РЅА cРђ▓) рхњ
­Юњ▒-base{╬╣}{c}{cРђ▓} = РЅАрхњ-intro ╬╗ k Рєњ (╬╗ x Рєњ x) , (╬╗ x Рєњ x)

­Юњ▒-fun : Рѕђ{A B AРђ▓ BРђ▓}{AРіЉAРђ▓ : A РіЉ AРђ▓}{BРіЉBРђ▓ : B РіЉ BРђ▓}{N}{NРђ▓}
   Рєњ (­Юњ▒РЪд A РЄњ B , AРђ▓ РЄњ BРђ▓ , funРіЉ AРіЉAРђ▓ BРіЉBРђ▓ РЪД (кЏ N) (кЏ NРђ▓))
      РЅАрхњ (Рѕђрхњ[ W ] Рѕђрхњ[ WРђ▓ ] ((­Юњ▒РЪд A , AРђ▓ , AРіЉAРђ▓ РЪД W WРђ▓)
                         Рєњрхњ (Рё░РЪд B , BРђ▓ , BРіЉBРђ▓ РЪД (N [ W ]) (NРђ▓ [ WРђ▓ ]))))
­Юњ▒-fun {A}{B}{AРђ▓}{BРђ▓}{AРіЉAРђ▓}{BРіЉBРђ▓}{N}{NРђ▓} =
   let XРѓЂ = injРѓЂ ((A РЄњ B , AРђ▓ РЄњ BРђ▓ , funРіЉ AРіЉAРђ▓ BРіЉBРђ▓) , кЏ N , кЏ NРђ▓) in
   let XРѓѓ = ╬╗ W WРђ▓ Рєњ injРѓЂ ((A , AРђ▓ , AРіЉAРђ▓) , W , WРђ▓) in
   let XРѓЃ = ╬╗ W WРђ▓ Рєњ injРѓѓ ((B , BРђ▓ , BРіЉBРђ▓) , N [ W ] , NРђ▓ [ WРђ▓ ]) in
   (­Юњ▒РЪд A РЄњ B , AРђ▓ РЄњ BРђ▓ , funРіЉ AРіЉAРђ▓ BРіЉBРђ▓ РЪД (кЏ N) (кЏ NРђ▓))    РЕдРЪе РЅАрхњ-refl refl РЪЕ
   Рё░Ріј­Юњ▒ XРѓЂ                                            РЕдРЪе fixpointрхњ pre-Рё░Ріј­Юњ▒ XРѓЂ РЪЕ
   # (pre-Рё░Ріј­Юњ▒ XРѓЂ) (Рё░Ріј­Юњ▒ , ttрхќ)
     РЕдРЪе cong-Рѕђ (╬╗ W Рєњ cong-Рѕђ ╬╗ WРђ▓ Рєњ
           cong-Рєњ (РЅАрхњ-sym (fixpointрхњ pre-Рё░Ріј­Юњ▒ (XРѓѓ W WРђ▓)))
                  (РЅАрхњ-sym (fixpointрхњ pre-Рё░Ріј­Юњ▒ (XРѓЃ W WРђ▓)))) РЪЕ
   (Рѕђрхњ[ W ] Рѕђрхњ[ WРђ▓ ] (­Юњ▒РЪд A , AРђ▓ , AРіЉAРђ▓ РЪД W WРђ▓
                    Рєњрхњ Рё░РЪд B , BРђ▓ , BРіЉBРђ▓ РЪД (N [ W ]) (NРђ▓ [ WРђ▓ ])))    Рѕј

{------------- Intro for ­Юњ▒ ---------------------------------------------------}

­Юњ▒-base-intro : Рѕђ{­ЮњФ}{╬╣}{c} Рєњ ­ЮњФ Рібрхњ ­Юњ▒РЪд ($Рѓю ╬╣ , $Рѓю ╬╣ , baseРіЉ) РЪД ($ c) ($ c)
­Юњ▒-base-intro{╬╣}{c} = substрхњ (РЅАрхњ-sym ­Юњ▒-base) (constрхњI refl)

{------------- Elim for Рё░ ----------------------------------------------------}

Рё░-diverge : Рѕђ{­ЮњФ}{c}{M}{MРђ▓}
   Рєњ ­ЮњФ Рібрхњ Рё░РЪд c РЪД M MРђ▓
   Рєњ ­ЮњФ Рібрхњ РЄЉрхњ MРђ▓ Рєњрхњ РЄЉрхњ M
Рё░-diverge {­ЮњФ}{c}{M}{MРђ▓} Рё░MMРђ▓ = projРѓЂрхњ (substрхњ Рё░-stmt Рё░MMРђ▓)

Рё░-diverge-later : Рѕђ{­ЮњФ}{c}{M}{MРђ▓}
   Рєњ ­ЮњФ Рібрхњ Рё░РЪд c РЪД M MРђ▓
   Рєњ ­ЮњФ Рібрхњ Рќирхњ (РЄЉрхњ MРђ▓)
   Рєњ ­ЮњФ Рібрхњ Рќирхњ (РЄЉрхњ M)
Рё░-diverge-later {­ЮњФ}{c}{M}{MРђ▓} Рё░MMРђ▓ РќиРЄЉMРђ▓ =
    appрхњ (РќиРєњ (monoрхњ (Рё░-diverge Рё░MMРђ▓))) РќиРЄЉMРђ▓

Рё░-converge : Рѕђ{­ЮњФ}{c}{M}{MРђ▓}{VРђ▓}{R}
   Рєњ ­ЮњФ Рібрхњ Рё░РЪд c РЪД M MРђ▓
   Рєњ ­ЮњФ Рібрхњ (MРђ▓ РЄЊ VРђ▓)рхњ
   Рєњ ­ЮњФ Рібрхњ (Value VРђ▓)рхњ
   Рєњ (Рѕђ V Рєњ (M РЄЊ V)рхњ ├Ќрхњ (Value V)рхњ ├Ќрхњ ­Юњ▒РЪд c РЪД V VРђ▓ Рѕи ­ЮњФ Рібрхњ R)
   Рєњ ­ЮњФ Рібрхњ R
Рё░-converge {­ЮњФ}{c}{M}{MРђ▓}{VРђ▓}{R} Рё░MMРђ▓ MРђ▓РЄЊVРђ▓ vРђ▓ cont =
  let ex = appрхњ (appрхњ (instрхњ (projРѓѓрхњ (substрхњ Рё░-stmt Рё░MMРђ▓)) VРђ▓) MРђ▓РЄЊVРђ▓) vРђ▓ in
  Рібрхњ-РѕЃ-elim ex cont


{------------- Elim for ­Юњ▒, by cases on A РіЉ AРђ▓ --------------------------------}

­Юњ▒-base-elim : Рѕђ{­ЮњФ}{V}{VРђ▓}{R}{╬╣}
  Рєњ ­ЮњФ Рібрхњ ­Юњ▒РЪд $Рѓю ╬╣ , $Рѓю ╬╣ , baseРіЉ РЪД V VРђ▓
  Рєњ (Рѕђ c Рєњ V РЅА $ c Рєњ VРђ▓ РЅА $ c Рєњ ­ЮњФ Рібрхњ R)
  Рєњ ­ЮњФ Рібрхњ R
­Юњ▒-base-elim {­ЮњФ}{V}{VРђ▓}{R}{╬╣} Ріб­Юњ▒VVРђ▓ cont =
  Рібрхњ-sucP Ріб­Юњ▒VVРђ▓ ╬╗ ­Юњ▒VVРђ▓ Рєњ aux ­Юњ▒VVРђ▓ cont
  where
  aux : Рѕђ{­ЮњФ}{V}{VРђ▓}{R}{k}{╬╣}
    Рєњ #(­Юњ▒РЪд $Рѓю ╬╣ , $Рѓю ╬╣ , baseРіЉ РЪД V VРђ▓) (suc k)
    Рєњ (Рѕђ c Рєњ V РЅА $ c Рєњ VРђ▓ РЅА $ c Рєњ ­ЮњФ Рібрхњ R)
    Рєњ ­ЮњФ Рібрхњ R
  aux {­ЮњФ}{$ c}{$ cРђ▓}{R}{k}{╬╣} refl cont = cont c refl refl

­Юњ▒-dyn-dyn-elim : Рѕђ{­ЮњФ}{V}{VРђ▓}{R}
   Рєњ ­ЮњФ Рібрхњ ­Юњ▒РЪд РўЁ , РўЁ , unkРіЉ РЪД V VРђ▓
   Рєњ (Рѕђ VРѓЂ VРђ▓РѓЂ G Рєњ Value VРѓЂ Рєњ Value VРђ▓РѓЂ Рєњ V РЅА VРѓЂ РЪе G !РЪЕ Рєњ VРђ▓ РЅА VРђ▓РѓЂ РЪе G !РЪЕ
       Рєњ ­ЮњФ Рібрхњ Рќирхњ ­Юњ▒РЪд gndРЄњty G , gndРЄњty G , ReflРіЉ РЪД VРѓЂ VРђ▓РѓЂ Рєњ ­ЮњФ Рібрхњ R)
   Рєњ ­ЮњФ Рібрхњ R
­Юњ▒-dyn-dyn-elim {­ЮњФ}{V}{VРђ▓}{R} Ріб­Юњ▒VVРђ▓ cont =
  Рібрхњ-sucP Ріб­Юњ▒VVРђ▓ ╬╗ ­Юњ▒VVРђ▓ Рєњ aux ­Юњ▒VVРђ▓ Ріб­Юњ▒VVРђ▓ cont
  where
  aux : Рѕђ{­ЮњФ}{V}{VРђ▓}{R}{k}
     Рєњ #(­Юњ▒РЪд РўЁ , РўЁ , unkРіЉ РЪД V VРђ▓) (suc k)
     Рєњ ­ЮњФ Рібрхњ ­Юњ▒РЪд РўЁ , РўЁ , unkРіЉ РЪД V VРђ▓
     Рєњ (Рѕђ VРѓЂ VРђ▓РѓЂ G Рєњ Value VРѓЂ Рєњ Value VРђ▓РѓЂ Рєњ V РЅА VРѓЂ РЪе G !РЪЕ Рєњ VРђ▓ РЅА VРђ▓РѓЂ РЪе G !РЪЕ
         Рєњ ­ЮњФ Рібрхњ Рќирхњ ­Юњ▒РЪд gndРЄњty G , gndРЄњty G , ReflРіЉ РЪД VРѓЂ VРђ▓РѓЂ Рєњ ­ЮњФ Рібрхњ R)
     Рєњ ­ЮњФ Рібрхњ R
  aux {­ЮњФ}{V РЪе G !РЪЕ}{VРђ▓ РЪе H !РЪЕ}{R} ­Юњ▒VVРђ▓ Ріб­Юњ▒VVРђ▓ cont
      with G РЅАрхЇ H | ­Юњ▒VVРђ▓
  ... | yes refl | (v , vРђ▓ , _) =
        let Рќи­Юњ▒VVРђ▓ = projРѓѓрхњ (projРѓѓрхњ (substрхњ ­Юњ▒-dyn-dyn Ріб­Юњ▒VVРђ▓)) in
        cont V VРђ▓ G v vРђ▓ refl refl Рќи­Юњ▒VVРђ▓
  ... | no neq | ()

­Юњ▒-dyn-any-elim : Рѕђ{­ЮњФ}{V}{VРђ▓}{AРђ▓}{R}
   Рєњ AРђ▓ РЅб РўЁ
   Рєњ ­ЮњФ Рібрхњ ­Юњ▒РЪд РўЁ , AРђ▓ , unkРіЉ РЪД V VРђ▓
   Рєњ (Рѕђ VРѓЂ G Рєњ Value VРѓЂ Рєњ V РЅА VРѓЂ РЪе G !РЪЕ Рєњ Value VРђ▓ Рєњ (GРіЉAРђ▓ : gndРЄњty G РіЉ AРђ▓)
       Рєњ ­ЮњФ Рібрхњ Рќирхњ ­Юњ▒РЪд gndРЄњty G , AРђ▓ , GРіЉAРђ▓ РЪД VРѓЂ VРђ▓
       Рєњ ­ЮњФ Рібрхњ R)
   Рєњ ­ЮњФ Рібрхњ R
­Юњ▒-dyn-any-elim {­ЮњФ}{V}{VРђ▓}{AРђ▓}{R} And Ріб­Юњ▒VVРђ▓ cont =
  Рібрхњ-sucP Ріб­Юњ▒VVРђ▓ ╬╗ ­Юњ▒VVРђ▓ Рєњ aux ­Юњ▒VVРђ▓ And Ріб­Юњ▒VVРђ▓ cont
  where
  aux : Рѕђ{­ЮњФ}{V}{VРђ▓}{AРђ▓}{R}{k}
     Рєњ #(­Юњ▒РЪд РўЁ , AРђ▓ , unkРіЉ РЪД V VРђ▓) (suc k)
     Рєњ AРђ▓ РЅб РўЁ
     Рєњ ­ЮњФ Рібрхњ ­Юњ▒РЪд РўЁ , AРђ▓ , unkРіЉ РЪД V VРђ▓
     Рєњ (Рѕђ VРѓЂ G Рєњ Value VРѓЂ Рєњ V РЅА VРѓЂ РЪе G !РЪЕ Рєњ Value VРђ▓ Рєњ (GРіЉAРђ▓ : gndРЄњty G РіЉ AРђ▓)
         Рєњ ­ЮњФ Рібрхњ Рќирхњ ­Юњ▒РЪд gndРЄњty G , AРђ▓ , GРіЉAРђ▓ РЪД VРѓЂ VРђ▓
         Рєњ ­ЮњФ Рібрхњ R)
     Рєњ ­ЮњФ Рібрхњ R
  aux {­ЮњФ} {V} {VРђ▓} {РўЁ}  {R} {k} ­Юњ▒VVРђ▓ nd Ріб­Юњ▒VVРђ▓ cont =
     РіЦ-elim (nd refl)
  aux {­ЮњФ} {V РЪе G !РЪЕ} {VРђ▓} {$Рѓю ╬╣}  {R} {k}  ­Юњ▒VVРђ▓ nd Ріб­Юњ▒VVРђ▓ cont
      with gndРЄњty G РіЉ? ($Рѓю ╬╣) | ­Юњ▒VVРђ▓
  ... | yes lt | (v , vРђ▓ , _) =
        let Рќи­Юњ▒VVРђ▓ = projРѓѓрхњ (projРѓѓрхњ (substрхњ (­Юњ▒-dyn-any lt) Ріб­Юњ▒VVРђ▓)) in
        cont V G v refl vРђ▓ lt Рќи­Юњ▒VVРђ▓
  ... | no nlt | ()
  aux {­ЮњФ} {V РЪе G !РЪЕ} {VРђ▓} {AРђ▓ РЄњ BРђ▓}  {R} {k} ­Юњ▒VVРђ▓ nd Ріб­Юњ▒VVРђ▓ cont
      with gndРЄњty G РіЉ? (AРђ▓ РЄњ BРђ▓) | ­Юњ▒VVРђ▓
  ... | yes lt | (v , vРђ▓ , _) =
        let Рќи­Юњ▒VVРђ▓ = projРѓѓрхњ (projРѓѓрхњ (substрхњ (­Юњ▒-dyn-any lt) Ріб­Юњ▒VVРђ▓)) in
        cont V G v refl vРђ▓ lt Рќи­Юњ▒VVРђ▓
  ... | no nlt | ()

­Юњ▒-fun-elim : Рѕђ{­ЮњФ}{A}{B}{AРђ▓}{BРђ▓}{c : A РіЉ AРђ▓}{d : B РіЉ BРђ▓}{V}{VРђ▓}{R}
   Рєњ ­ЮњФ Рібрхњ ­Юњ▒РЪд A РЄњ B , AРђ▓ РЄњ BРђ▓ , funРіЉ c d РЪД V VРђ▓
   Рєњ (Рѕђ N NРђ▓ Рєњ V РЅА кЏ N Рєњ VРђ▓ РЅА кЏ NРђ▓ 
             Рєњ (Рѕђ W WРђ▓ Рєњ ­ЮњФ Рібрхњ (­Юњ▒РЪд A , AРђ▓ , c РЪД W WРђ▓)
                            Рєњрхњ (Рё░РЪд B , BРђ▓ , d РЪД (N [ W ]) (NРђ▓ [ WРђ▓ ])))
             Рєњ ­ЮњФ Рібрхњ R)
     --------------------------------------------------------------------
   Рєњ ­ЮњФ Рібрхњ R
­Юњ▒-fun-elim {­ЮњФ}{A}{B}{AРђ▓}{BРђ▓}{c}{d}{V}{VРђ▓}{R} Ріб­Юњ▒VVРђ▓ cont =
  Рібрхњ-sucP Ріб­Юњ▒VVРђ▓ ╬╗ { ­Юњ▒VVРђ▓sn Рєњ aux {V}{VРђ▓} ­Юњ▒VVРђ▓sn Ріб­Юњ▒VVРђ▓ cont }
  where
  aux : Рѕђ{V}{VРђ▓}{n}
     Рєњ # (­Юњ▒РЪд  A РЄњ B , AРђ▓ РЄњ BРђ▓ , funРіЉ c d РЪД V VРђ▓) (suc n)
     Рєњ ­ЮњФ Рібрхњ ­Юњ▒РЪд A РЄњ B , AРђ▓ РЄњ BРђ▓ , funРіЉ c d РЪД V VРђ▓
     Рєњ (Рѕђ N NРђ▓ Рєњ V РЅА кЏ N Рєњ VРђ▓ РЅА кЏ NРђ▓ 
             Рєњ (Рѕђ W WРђ▓ Рєњ ­ЮњФ Рібрхњ (­Юњ▒РЪд A , AРђ▓ , c РЪД W WРђ▓)
                             Рєњрхњ (Рё░РЪд B , BРђ▓ , d РЪД (N [ W ]) (NРђ▓ [ WРђ▓ ])))
             Рєњ ­ЮњФ Рібрхњ R)
     Рєњ ­ЮњФ Рібрхњ R
  aux {кЏ N}{кЏ NРђ▓}{n} ­Юњ▒VVРђ▓ Ріб­Юњ▒VVРђ▓ cont = cont N NРђ▓ refl refl ╬╗ W WРђ▓ Рєњ
     instрхњ (instрхњ (substрхњ ­Юњ▒-fun Ріб­Юњ▒VVРђ▓) W) WРђ▓ 

{------------------- Relate Open Terms -------------------------------------}

­ЮЊќРЪд_РЪД : (╬Њ : List Prec) Рєњ Subst Рєњ Subst Рєњ List Setрхњ
­ЮЊќРЪд [] РЪД ¤Ѓ ¤ЃРђ▓ = []
­ЮЊќРЪд c Рѕи ╬Њ РЪД ¤Ѓ ¤ЃРђ▓ = (­Юњ▒РЪд c РЪД (¤Ѓ 0) (¤ЃРђ▓ 0))
                     Рѕи ­ЮЊќРЪд ╬Њ РЪД (╬╗ x Рєњ ¤Ѓ (suc x)) (╬╗ x Рєњ ¤ЃРђ▓ (suc x))

_Ріе_РіЉ_Рдѓ_ : List Prec Рєњ Term Рєњ Term Рєњ Prec Рєњ Set
╬Њ Ріе M РіЉ MРђ▓ Рдѓ c = Рѕђ (╬│ ╬│Рђ▓ : Subst)
   Рєњ ­ЮЊќРЪд ╬Њ РЪД ╬│ ╬│Рђ▓ Рібрхњ Рё░РЪд c РЪД (РЪф ╬│ РЪФ M) (РЪф ╬│Рђ▓ РЪФ MРђ▓)

{------------------- Related values are syntactic values ----------------------}

­Юњ▒РЄњValue : Рѕђ {k} c M MРђ▓
   Рєњ # (­Юњ▒РЪд c РЪД M MРђ▓) (suc k)
     ------------------------
   Рєњ Value M ├Ќ Value MРђ▓
­Юњ▒РЄњValue {k} (.РўЁ , РўЁ , unkРіЉ) (V РЪе G !РЪЕ) (VРђ▓ РЪе H !РЪЕ) ­Юњ▒MMРђ▓
    with G РЅАрхЇ H
... | no neq = РіЦ-elim ­Юњ▒MMРђ▓
... | yes refl
    with ­Юњ▒MMРђ▓
... | v , vРђ▓ , _ = (v РїЕ G Рїф) , (vРђ▓ РїЕ G Рїф)
­Юњ▒РЄњValue {k} (.РўЁ , $Рѓю ╬╣ , unkРіЉ) (V РЪе G !РЪЕ) VРђ▓ ­Юњ▒MMРђ▓
    with (gndРЄњty G) РіЉ? ($Рѓю ╬╣)
... | no nlt = РіЦ-elim ­Юњ▒MMРђ▓
... | yes lt
    with ­Юњ▒MMРђ▓
... | v , vРђ▓ , _ = (v РїЕ G Рїф) , vРђ▓
­Юњ▒РЄњValue {k} (.РўЁ , (AРђ▓ РЄњ BРђ▓) , unkРіЉ) (V РЪе G !РЪЕ) VРђ▓ ­Юњ▒MMРђ▓
    with (gndРЄњty G) РіЉ? (AРђ▓ РЄњ BРђ▓)
... | no nlt = РіЦ-elim ­Юњ▒MMРђ▓
... | yes lt
    with ­Юњ▒MMРђ▓
... | v , vРђ▓ , _ = (v РїЕ G Рїф) , vРђ▓
­Юњ▒РЄњValue {k} ($Рѓю ╬╣ , $Рѓю ╬╣ , baseРіЉ) ($ c) ($ cРђ▓) refl = ($╠г c) , ($╠г c)
­Юњ▒РЄњValue {k} ((A РЄњ B) , (AРђ▓ РЄњ BРђ▓) , funРіЉ AРіЉAРђ▓ BРіЉBРђ▓) (кЏ N) (кЏ NРђ▓) ­Юњ▒VVРђ▓ =
    (кЏ╠г N) , (кЏ╠г NРђ▓)

{- Related values are related expressions -}

­Юњ▒РЄњРё░-pred : Setрхњ
­Юњ▒РЄњРё░-pred = Рѕђрхњ[ c ] Рѕђрхњ[ V ] Рѕђрхњ[ VРђ▓ ] ­Юњ▒РЪд c РЪД V VРђ▓ Рєњрхњ Рё░РЪд c РЪД V VРђ▓

­Юњ▒РЄњРё░рхњ : Рѕђ{­ЮњФ}
   Рєњ ­ЮњФ Рібрхњ Рѕђрхњ[ c ] Рѕђрхњ[ V ] Рѕђрхњ[ VРђ▓ ] ­Юњ▒РЪд c РЪД V VРђ▓ Рєњрхњ Рё░РЪд c РЪД V VРђ▓
­Юњ▒РЄњРё░рхњ {­ЮњФ} = lobрхњ (╬Џрхњ[ c ] ╬Џрхњ[ V ] ╬Џрхњ[ VРђ▓ ] (РєњрхњI Goal))
 where
 Goal : Рѕђ{c}{V}{VРђ▓}
    Рєњ ­Юњ▒РЪд c РЪД V VРђ▓ Рѕи (Рќирхњ ­Юњ▒РЄњРё░-pred) Рѕи ­ЮњФ Рібрхњ Рё░РЪд c РЪД V VРђ▓
 Goal {РўЁ , AРђ▓ , unkРіЉ} {V} {VРђ▓}
     with dyn? AРђ▓ 
 ... | no AРђ▓РЅбРўЁ =
      ­Юњ▒-dyn-any-elim AРђ▓РЅбРўЁ Zрхњ ╬╗{W G w refl wРђ▓ GРіЉAРђ▓ РібРќи­Юњ▒WVРђ▓ Рєњ
      substрхњ (РЅАрхњ-sym Рё░-stmt)
      ((РєњрхњI{P = РЄЉрхњ VРђ▓}
        (Рібрхњ-intro ╬╗ { zero (РЄЉVРђ▓n , _) Рєњ РЄЉzero
                    ; (suc n) (РЄЉVРђ▓sn , ­Юњ▒W!VРђ▓ , Рќи­Юњ▒РЄњРё░ , asms) Рєњ
         let ­Юњ▒WVРђ▓ = Рібрхњ-elim РібРќи­Юњ▒WVРђ▓ (suc n) (­Юњ▒W!VРђ▓ , (Рќи­Юњ▒РЄњРё░ , asms)) in
         let (Рё░WVРђ▓ , _) = Рќи­Юњ▒РЄњРё░ (gndРЄњty G , AРђ▓ , GРіЉAРђ▓) W VРђ▓ n РЅц-refl ­Юњ▒WVРђ▓ in
         let РЄЉVРђ▓n = downClosedРЄЉ (suc n) РЄЉVРђ▓sn n (nРЅц1+n n) in
         let РЄЉW = Рё░WVРђ▓ n РЅц-refl РЄЉVРђ▓n in
         РЄЉinj РЄЉW})
         )
       ,рхњ
          Рібрхњ-intro
          ╬╗ { zero x a j zРЅцn xРѓѓ jРѓЂ zРЅцn xРѓё Рєњ
              (W РЪе G !РЪЕ) , (tt , (tt , tz (­Юњ▒РЪд РўЁ , AРђ▓ , unkРіЉ РЪД (W РЪе G !РЪЕ) a)))
            ; (suc n) x a zero xРѓЂ xРѓѓ zero zРЅцn xРѓё Рєњ
               tz (РѕЃрхњ-syntax (╬╗ VРѓЂ Рєњ РѕЃV­Юњ▒ (РўЁ , AРђ▓ , unkРіЉ) (W РЪе G !РЪЕ) VРѓЂ a))
            ; (suc n) x a (suc j) (sРЅцs jРЅцn) VРђ▓РЄЊ zero zРЅцn xРѓё Рєњ
               tz (РѕЃрхњ-syntax (╬╗ VРѓЂ Рєњ РѕЃV­Юњ▒ (РўЁ , AРђ▓ , unkРіЉ) (W РЪе G !РЪЕ) VРѓЂ a))
            ; (suc n) x a (suc j) (sРЅцs jРЅцn) VРђ▓РЄЊ (suc jРѓЂ) (sРЅцs jРѓЂРЅцj) xРѓё Рєњ
              
              {!!} , ((injРЄЊ {!!} {!!}) , ({!!} , {!!}))
            }
          {-
          (╬Џрхњ[ VРђ│ ] (РєњрхњI{P = (VРђ▓ РЄЊ VРђ│)рхњ} (РєњрхњI{P = (Value VРђ│)рхњ }
           let ­ЮњФРѓЂ = Value VРђ│ рхњ Рѕи (VРђ▓ РЄЊ VРђ│) рхњ
                   Рѕи ­Юњ▒РЪд РўЁ , AРђ▓ , unkРіЉ РЪД (W РЪе G !РЪЕ) VРђ▓ Рѕи (Рќирхњ ­Юњ▒РЄњРё░-pred) Рѕи ­ЮњФ in
           let Рќи­Юњ▒РЄњРё░ : ­ЮњФРѓЂ Рібрхњ Рќирхњ ­Юњ▒РЄњРё░-pred
               Рќи­Юњ▒РЄњРё░ = Sрхњ (Sрхњ (Sрхњ Zрхњ)) in
           let F = ╬╗ c Рєњ Рќирхњ (Рѕђрхњ[ V ] Рѕђрхњ[ VРђ▓ ] ­Юњ▒РЪд c РЪД V VРђ▓ Рєњрхњ Рё░РЪд c РЪД V VРђ▓) in
           let РќиРё░WVРђ▓ : ­ЮњФРѓЂ Рібрхњ Рќирхњ Рё░РЪд gndРЄњty G , AРђ▓ , GРіЉAРђ▓ РЪД W VРђ▓
               РќиРё░WVРђ▓ = appрхњ (РќиРєњ (instрхњ (РќиРѕђ (instрхњ (РќиРѕђ (instрхњ{P = F} (РќиРѕђ Рќи­Юњ▒РЄњРё░)
                        (gndРЄњty G , AРђ▓ , GРіЉAРђ▓))) W)) VРђ▓)) (Sрхњ (Sрхњ РібРќи­Юњ▒WVРђ▓)) in
           --Рё░-converge Zрхњ 
            
            {!!})))
            -}
            )
      }
 ... | yes refl =
      ­Юњ▒-dyn-dyn-elim{V = V}{VРђ▓} Zрхњ ╬╗{W WРђ▓ G w wРђ▓ refl refl РібРќи­Юњ▒WWРђ▓ Рєњ
      substрхњ (РЅАрхњ-sym Рё░-stmt)
      ((РєњрхњI{P = РЄЉрхњ (WРђ▓ РЪе G !РЪЕ)}
      (Рібрхњ-intro ╬╗ { zero (РЄЉWРђ▓! , _) Рєњ РЄЉzero
                  ; (suc n) (РЄЉinj РЄЉWРђ▓ , ­Юњ▒W!WРђ▓! , Рќи­Юњ▒РЄњРё░ , asms) Рєњ
       let ­Юњ▒WWРђ▓ = Рібрхњ-elim РібРќи­Юњ▒WWРђ▓ (suc n) (­Юњ▒W!WРђ▓! , (Рќи­Юњ▒РЄњРё░ , asms)) in
       let (Рё░WWРђ▓ , _) = Рќи­Юњ▒РЄњРё░ (gndРЄњty G , gndРЄњty G , ReflРіЉ) W WРђ▓ n РЅц-refl ­Юњ▒WWРђ▓ in
       let РЄЉW = Рё░WWРђ▓ n РЅц-refl РЄЉWРђ▓ in
       РЄЉinj РЄЉW}
      ))
      ,рхњ {!!})
      }
 Goal {.($Рѓю _) , .($Рѓю _) , baseРіЉ} {V} {VРђ▓} =
     ­Юњ▒-base-elim Zрхњ ╬╗{ c refl refl Рєњ
     substрхњ (РЅАрхњ-sym Рё░-stmt)
     ((РєњрхњI{P = РЄЉрхњ ($ c)}
            (Рібрхњ-intro ╬╗ { .zero (РЄЉzero , asms) Рєњ РЄЉzero}))
      ,рхњ {!!})
     }
 Goal {.(_ РЄњ _) , .(_ РЄњ _) , funРіЉ AРіЉAРђ▓ AРіЉAРђ▓РѓЂ} {V} {VРђ▓} =
     ­Юњ▒-fun-elim Zрхњ ╬╗{ N NРђ▓ refl refl ­Юњ▒WРєњРё░NW Рєњ
     substрхњ (РЅАрхњ-sym Рё░-stmt)
     ((РєњрхњI{P = РЄЉрхњ (кЏ NРђ▓)}
      (Рібрхњ-intro ╬╗ { zero x Рєњ РЄЉzero}))
     ,рхњ {!!})
     }

­Юњ▒РЄњРё░ : Рѕђ{c : Prec}{­ЮњФ}{V}{VРђ▓}
   Рєњ ­ЮњФ Рібрхњ ­Юњ▒РЪд c РЪД V VРђ▓
     -----------------
   Рєњ ­ЮњФ Рібрхњ Рё░РЪд c РЪД V VРђ▓
­Юњ▒РЄњРё░ {c} {­ЮњФ} {V} {VРђ▓} Ріб­Юњ▒VVРђ▓ = appрхњ (instрхњ (instрхњ (instрхњ ­Юњ▒РЄњРё░рхњ c) V) VРђ▓) Ріб­Юњ▒VVРђ▓ 

{---------- Blame is more precise than any term -------------------------------}

Рё░-blame : Рѕђ{­ЮњФ}{c}{M} Рєњ ­ЮњФ Рібрхњ Рё░РЪд c РЪД M blame
Рё░-blame {­ЮњФ} {c} {M} = substрхњ (РЅАрхњ-sym Рё░-stmt)
    ((Рібрхњ-intro ╬╗ { n x .zero xРѓЂ РЄЉzero Рєњ РЄЉzero})
    ,рхњ {!!})
    
{---------- Compatbility Lemmas -----------------------------------------------}

compatible-nat : Рѕђ{╬Њ}{n : РёЋ}
   Рєњ ╬Њ Ріе $ (Num n) РіЉ $ (Num n) Рдѓ ($Рѓю Рђ▓РёЋ , $Рѓю Рђ▓РёЋ , baseРіЉ)
compatible-nat {╬Њ}{n} ╬│ ╬│Рђ▓ = ­Юњ▒РЄњРё░ (substрхњ (РЅАрхњ-sym ­Юњ▒-base) (constрхњI refl))

compatible-bool : Рѕђ{╬Њ}{b : ­Юћ╣}
   Рєњ ╬Њ Ріе $ (Bool b) РіЉ $ (Bool b) Рдѓ ($Рѓю Рђ▓­Юћ╣ , $Рѓю Рђ▓­Юћ╣ , baseРіЉ)
compatible-bool {╬Њ}{b} ╬│ ╬│Рђ▓ = ­Юњ▒РЄњРё░ (substрхњ (РЅАрхњ-sym ­Юњ▒-base) (constрхњI refl))

compatible-blame : Рѕђ{╬Њ}{A}{M}
   Рєњ map projРѓЂ ╬Њ Ріб M Рдѓ A
     -------------------------------
   Рєњ ╬Њ Ріе M РіЉ blame Рдѓ (A , A , ReflРіЉ)
compatible-blame РібM ╬│ ╬│Рђ▓ = Рё░-blame

lookup-­ЮЊќ : (╬Њ : List Prec) Рєњ (╬│ ╬│Рђ▓ : Subst)
  Рєњ Рѕђ {A}{AРђ▓}{AРіЉAРђ▓}{y} Рєњ ╬Њ РѕІ y Рдѓ (A , AРђ▓ , AРіЉAРђ▓)
  Рєњ ­ЮЊќРЪд ╬Њ РЪД ╬│ ╬│Рђ▓ Рібрхњ ­Юњ▒РЪд (A , AРђ▓ , AРіЉAРђ▓) РЪД (╬│ y) (╬│Рђ▓ y)
lookup-­ЮЊќ (.(A , AРђ▓ , AРіЉAРђ▓) Рѕи ╬Њ) ╬│ ╬│Рђ▓ {A} {AРђ▓} {AРіЉAРђ▓} {zero} refl = Zрхњ
lookup-­ЮЊќ (B Рѕи ╬Њ) ╬│ ╬│Рђ▓ {A} {AРђ▓} {AРіЉAРђ▓} {suc y} РѕІy =
   Sрхњ (lookup-­ЮЊќ ╬Њ (╬╗ x Рєњ ╬│ (suc x)) (╬╗ x Рєњ ╬│Рђ▓ (suc x)) РѕІy)

compatibility-var : Рѕђ {╬Њ A AРђ▓ AРіЉAРђ▓ x}
  Рєњ ╬Њ РѕІ x Рдѓ (A , AРђ▓ , AРіЉAРђ▓)
    -------------------------------
  Рєњ ╬Њ Ріе ` x РіЉ ` x Рдѓ (A , AРђ▓ , AРіЉAРђ▓)
compatibility-var {╬Њ}{A}{AРђ▓}{AРіЉAРђ▓}{x} РѕІx ╬│ ╬│Рђ▓
    rewrite sub-var ╬│ x | sub-var ╬│Рђ▓ x = ­Юњ▒РЄњРё░ (lookup-­ЮЊќ ╬Њ ╬│ ╬│Рђ▓ РѕІx)

compatible-lambda : Рѕђ{╬Њ : List Prec}{A}{B}{C}{D}{N NРђ▓ : Term}
     {c : A РіЉ C}{d : B РіЉ D}
   Рєњ ((A , C , c) Рѕи ╬Њ) Ріе N РіЉ NРђ▓ Рдѓ (B , D , d)
     -----------------------------------------------
   Рєњ ╬Њ Ріе (кЏ N) РіЉ (кЏ NРђ▓) Рдѓ (A РЄњ B , C РЄњ D , funРіЉ c d)
compatible-lambda{╬Њ}{A}{B}{C}{D}{N}{NРђ▓}{c}{d} РіеNРіЉNРђ▓ ╬│ ╬│Рђ▓ = РібРё░╬╗N╬╗NРђ▓
 where
 РібРё░╬╗N╬╗NРђ▓ : ­ЮЊќРЪд ╬Њ РЪД ╬│ ╬│Рђ▓
            Рібрхњ Рё░РЪд A РЄњ B , C РЄњ D , funРіЉ c d РЪД (РЪф ╬│ РЪФ (кЏ N)) (РЪф ╬│Рђ▓ РЪФ (кЏ NРђ▓))
 РібРё░╬╗N╬╗NРђ▓ = ­Юњ▒РЄњРё░ (substрхњ (РЅАрхњ-sym ­Юњ▒-fun) (╬Џрхњ[ W ] ╬Џрхњ[ WРђ▓ ] РєњрхњI ­ЮЊћN[W]NРђ▓[WРђ▓]))
  where
  ­ЮЊћN[W]NРђ▓[WРђ▓] : Рѕђ{W WРђ▓} Рєњ ­Юњ▒РЪд A , C , c РЪД W WРђ▓ Рѕи ­ЮЊќРЪд ╬Њ РЪД ╬│ ╬│Рђ▓
       Рібрхњ  Рё░РЪд B , D , d РЪД ((РЪф ext ╬│ РЪФ N) [ W ]) ((РЪф ext ╬│Рђ▓ РЪФ NРђ▓) [ WРђ▓ ])
  ­ЮЊћN[W]NРђ▓[WРђ▓] {W}{WРђ▓} = appрхњ (Sрхњ (РєњрхњI (РіеNРіЉNРђ▓ (W Рђб ╬│) (WРђ▓ Рђб ╬│Рђ▓)))) Zрхњ

compatible-app : Рѕђ{╬Њ}{A AРђ▓ B BРђ▓}{c : A РіЉ AРђ▓}{d : B РіЉ BРђ▓}{L LРђ▓ M MРђ▓}
   Рєњ ╬Њ Ріе L РіЉ LРђ▓ Рдѓ (A РЄњ B , AРђ▓ РЄњ BРђ▓ , funРіЉ c d)
   Рєњ ╬Њ Ріе M РіЉ MРђ▓ Рдѓ (A , AРђ▓ , c)
     ----------------------------------
   Рєњ ╬Њ Ріе L ┬и M РіЉ LРђ▓ ┬и MРђ▓ Рдѓ (B , BРђ▓ , d)
compatible-app {╬Њ}{A}{AРђ▓}{B}{BРђ▓}{c}{d}{L}{LРђ▓}{M}{MРђ▓} РіеLРіЉLРђ▓ РіеMРіЉMРђ▓ ╬│ ╬│Рђ▓ =
  substрхњ (РЅАрхњ-sym Рё░-stmt) ((РєњрхњI{P = РЄЉрхњ (РЪф ╬│Рђ▓ РЪФ (LРђ▓ ┬и MРђ▓))} Diverge) ,рхњ ToValue)
  where
  Diverge : РЄЉрхњ (РЪф ╬│Рђ▓ РЪФ (LРђ▓ ┬и MРђ▓)) Рѕи ­ЮЊќРЪд ╬Њ РЪД ╬│ ╬│Рђ▓ Рібрхњ РЄЉрхњ (РЪф ╬│ РЪФ (L ┬и M))
  Diverge =
     РібРЄЉapp-inv
     {- Case 1 -}
     (let РібрхњРЄЉL = Рё░-diverge-later (Sрхњ (РіеLРіЉLРђ▓ ╬│ ╬│Рђ▓)) Zрхњ
      in (РібрхњРЄЉapp-L РібрхњРЄЉL))
      
     {- Case 2 -}
     (╬╗ NРђ▓ Рєњ
      let ­ЮњФРѓѓ = (РЪф ╬│Рђ▓ РЪФ LРђ▓ РЄЊ кЏ NРђ▓)рхњ Рѕи Рќирхњ (РЄЉрхњ (РЪф ╬│Рђ▓ РЪФ MРђ▓)) Рѕи ­ЮЊќРЪд ╬Њ РЪД ╬│ ╬│Рђ▓ in
      Рё░-converge (Sрхњ (Sрхњ (РіеLРіЉLРђ▓ ╬│ ╬│Рђ▓))) Zрхњ (constрхњI (кЏ╠г NРђ▓)) ╬╗ V Рєњ
      let ­Юњ▒VVРђ▓ = projРѓѓрхњ (projРѓѓрхњ Zрхњ) in
      ­Юњ▒-fun-elim ­Юњ▒VVРђ▓ ╬╗ {N NРђ│ refl refl body Рєњ
      let LРЄЊV = projРѓЂрхњ Zрхњ in
      let РќиРЄЉMРђ▓ = Sрхњ (Sрхњ Zрхњ) in
      let ­ЮњФРѓЃ = РѕЃV­Юњ▒ (A РЄњ B , AРђ▓ РЄњ BРђ▓ , funРіЉ c d) (РЪф ╬│ РЪФ L) V (кЏ NРђ▓) Рѕи ­ЮњФРѓѓ in
      let РќиРЄЉM = Рё░-diverge-later{­ЮњФРѓЃ} (Sрхњ (Sрхњ (Sрхњ (РіеMРіЉMРђ▓ ╬│ ╬│Рђ▓)))) РќиРЄЉMРђ▓ in
      РібрхњРЄЉapp-R LРЄЊV РќиРЄЉM })
      
     {- Case 3 -}
     (╬╗ NРђ▓ WРђ▓ Рєњ
      let ­ЮњФРѓѓ = (РЪф ╬│Рђ▓ РЪФ LРђ▓ РЄЊ кЏ NРђ▓)рхњ Рѕи (РЪф ╬│Рђ▓ РЪФ MРђ▓ РЄЊ WРђ▓)рхњ Рѕи (Value WРђ▓)рхњ
               Рѕи Рќирхњ (РЄЉрхњ (NРђ▓ [ WРђ▓ ])) Рѕи ­ЮЊќРЪд ╬Њ РЪД ╬│ ╬│Рђ▓ in
      let EX = ╬╗ V VРђ▓ Рєњ (РЪф ╬│ РЪФ L РЄЊ V)рхњ ├Ќрхњ (Value V)рхњ
                        ├Ќрхњ ­Юњ▒РЪд A РЄњ B , AРђ▓ РЄњ BРђ▓ , funРіЉ c d РЪД V VРђ▓ in
      Рё░-converge (Sрхњ (Sрхњ (Sрхњ (Sрхњ (РіеLРіЉLРђ▓ ╬│ ╬│Рђ▓))))) Zрхњ (constрхњI (кЏ╠г NРђ▓)) ╬╗ V Рєњ
      let ­ЮњФРѓЃ = EX V (кЏ NРђ▓) Рѕи ­ЮњФРѓѓ in
      let LРЄЊV : ­ЮњФРѓЃ Рібрхњ (РЪф ╬│ РЪФ L РЄЊ V)рхњ
          LРЄЊV = projРѓЂрхњ Zрхњ in
      let MРђ▓РЄЊWРђ▓ = Sрхњ (Sрхњ Zрхњ) in
      let wРђ▓ = Sрхњ (Sрхњ (Sрхњ Zрхњ)) in
      let EX = ╬╗ W WРђ▓ Рєњ (РЪф ╬│ РЪФ M РЄЊ W)рхњ ├Ќрхњ (Value W)рхњ
                        ├Ќрхњ ­Юњ▒РЪд A , AРђ▓ , c РЪД W WРђ▓ in
      Рё░-converge{­ЮњФРѓЃ} (Sрхњ (Sрхњ (Sрхњ (Sрхњ (Sрхњ (РіеMРіЉMРђ▓ ╬│ ╬│Рђ▓)))))) MРђ▓РЄЊWРђ▓ wРђ▓ ╬╗ W Рєњ
      let ­ЮњФРѓё = EX W WРђ▓ Рѕи ­ЮњФРѓЃ in
      let ­Юњ▒VVРђ▓ = projРѓѓрхњ (projРѓѓрхњ (Sрхњ Zрхњ)) in
      ­Юњ▒-fun-elim{­ЮњФРѓё} ­Юњ▒VVРђ▓ ╬╗ {N NРђ│ refl refl body Рєњ
      let ­Юњ▒WWРђ▓ = projРѓѓрхњ (projРѓѓрхњ Zрхњ) in
      let Рё░NWNWРђ▓ = appрхњ (body W WРђ▓) ­Юњ▒WWРђ▓ in
      let РќиРЄЉNWРђ▓ = (Sрхњ (Sрхњ (Sрхњ (Sрхњ (Sрхњ Zрхњ)))))  in
      let РќиРЄЉNW = Рё░-diverge-later{­ЮњФРѓё} Рё░NWNWРђ▓ РќиРЄЉNWРђ▓ in
      let MРЄЊW = projРѓЂрхњ Zрхњ in
      let w = projРѓЂрхњ (projРѓѓрхњ Zрхњ) in
      РібрхњРЄЉapp (Sрхњ LРЄЊV) MРЄЊW w РќиРЄЉNW
      })
      
  ToValue :
     ­ЮЊќРЪд ╬Њ РЪД ╬│ ╬│Рђ▓ Рібрхњ (Рѕђрхњ[ VРђ▓ ] (РѕђVРђ▓РєњРѕЃV­Юњ▒ (B , BРђ▓ , d)  (РЪф ╬│ РЪФ (L ┬и M))
                              (РЪф ╬│Рђ▓ РЪФ (LРђ▓ ┬и MРђ▓)) VРђ▓))
  ToValue = ╬Џрхњ[ VРђ▓ ] РєњрхњI{P = ((РЪф ╬│Рђ▓ РЪФ (LРђ▓ ┬и MРђ▓)) РЄЊ VРђ▓)рхњ} (РєњрхњI{P = (Value VРђ▓)рхњ}
    (Рібрхњ-sucP Zрхњ ╬╗ vРђ▓ Рєњ 
    (Рібрхњ-sucP (Sрхњ Zрхњ) ╬╗ LMРђ▓РЄЊVРђ▓ Рєњ 
    Goal vРђ▓ LMРђ▓РЄЊVРђ▓
    )))
    where
    Goal : Рѕђ{VРђ▓}
       Рєњ Value VРђ▓
       Рєњ (РЪф ╬│Рђ▓ РЪФ (LРђ▓ ┬и MРђ▓)) РЄЊ VРђ▓
       Рєњ (Value VРђ▓)рхњ Рѕи ((РЪф ╬│Рђ▓ РЪФ (LРђ▓ ┬и MРђ▓)) РЄЊ VРђ▓)рхњ Рѕи ­ЮЊќРЪд ╬Њ РЪД ╬│ ╬│Рђ▓
            Рібрхњ РѕЃрхњ[ V ] (РѕЃV­Юњ▒ (B , BРђ▓ , d) (РЪф ╬│ РЪФ (L ┬и M)) V VРђ▓)
    Goal {VРђ▓} vРђ▓ (appРЄЊ{N = NРђ▓}{WРђ▓} LРђ▓РЄЊ╬╗NРђ▓ MРђ▓РЄЊWРђ▓ wРђ▓ NWРђ▓РЄЊVРђ▓) =
     Рё░-converge (Sрхњ (Sрхњ (РіеLРіЉLРђ▓ ╬│ ╬│Рђ▓))) (constрхњI LРђ▓РЄЊ╬╗NРђ▓) (constрхњI (кЏ╠г NРђ▓)) ╬╗ V Рєњ
     Рё░-converge (Sрхњ (Sрхњ (Sрхњ (РіеMРіЉMРђ▓ ╬│ ╬│Рђ▓)))) (constрхњI MРђ▓РЄЊWРђ▓) (constрхњI wРђ▓) ╬╗ W Рєњ
     let ­Юњ▒VVРђ▓ = projРѓѓрхњ (projРѓѓрхњ (Sрхњ Zрхњ)) in
     ­Юњ▒-fun-elim ­Юњ▒VVРђ▓ ╬╗ {N NРђ│ refl refl body Рєњ
     let ­Юњ▒WWРђ▓ = projРѓѓрхњ (projРѓѓрхњ Zрхњ) in
     Рё░-converge (appрхњ (body W WРђ▓) ­Юњ▒WWРђ▓) (constрхњI NWРђ▓РЄЊVРђ▓) (constрхњI vРђ▓) ╬╗ U Рєњ 
     Рібрхњ-РѕЃ-intro-new (╬╗ V Рєњ (РѕЃV­Юњ▒ (B , BРђ▓ , d) (РЪф ╬│ РЪФ (L ┬и M)) V VРђ▓)) U
     let u = projРѓЂрхњ (projРѓѓрхњ Zрхњ) in
     Рібрхњ-sucP (projРѓЂрхњ (Sрхњ (Sрхњ Zрхњ))) ╬╗ LРЄЊ Рєњ
     Рібрхњ-sucP (projРѓЂрхњ (Sрхњ Zрхњ)) ╬╗ MРЄЊ Рєњ
     Рібрхњ-sucP (projРѓЂрхњ (projРѓѓрхњ (Sрхњ Zрхњ))) ╬╗ w Рєњ
     Рібрхњ-sucP (projРѓЂрхњ Zрхњ) ╬╗ NWРЄЊU Рєњ
     (constрхњI (appРЄЊ LРЄЊ MРЄЊ w NWРЄЊU) ,рхњ (u ,рхњ projРѓѓрхњ (projРѓѓрхњ Zрхњ)))
     }
